CREATE
OR REPLACE TABLE {{ dataset }}.{{ table }} PARTITION BY DATE(created_at) AS
SELECT
    *
EXCEPT
    (row_num)
FROM
    (
        SELECT
            *,
            ROW_NUMBER() over (
                PARTITION BY id
                ORDER BY
                    updated_at DESC
            ) AS row_num
        FROM
            {{ dataset }}._stage_{{ table }}
    )
WHERE
    row_num = 1
